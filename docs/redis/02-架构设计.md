# Redis Commons - æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

Redis Commons é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œå°†å¤æ‚çš„ Redis æ“ä½œæŠ½è±¡ä¸ºæ¸…æ™°çš„æ¨¡å—å±‚æ¬¡ï¼Œç¡®ä¿é«˜å†…èšä½è€¦åˆçš„è®¾è®¡åŸåˆ™ã€‚æ•´ä½“æ¶æ„åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š

```mermaid
graph TD
    A[åº”ç”¨å±‚ Application Layer] --> B[é—¨é¢å±‚ Facade Layer]
    B --> C[æœåŠ¡å±‚ Service Layer]
    C --> D[æ“ä½œå±‚ Operations Layer]
    D --> E[æ ¸å¿ƒå±‚ Core Layer]
    E --> F[åŸºç¡€è®¾æ–½å±‚ Infrastructure Layer]

    A --> A1[æ³¨è§£é©±åŠ¨ @RedisCacheable]
    A --> A2[ç¼–ç¨‹å¼è°ƒç”¨ RedisUtils]
    A --> A3[AOPåˆ‡é¢ CacheAspect]

    B --> B1[RedisUtils é—¨é¢]
    B --> B2[ç»Ÿä¸€æ¥å£å°è£…]

    C --> C1[ç¼“å­˜æœåŠ¡ CacheService]
    C --> C2[é”ç®¡ç†æœåŠ¡ LockService]
    C --> C3[äº‹åŠ¡ç®¡ç†æœåŠ¡ TransactionService]
    C --> C4[æ‰¹é‡æ“ä½œæœåŠ¡ BatchService]

    D --> D1[String Operations]
    D --> D2[Hash Operations]
    D --> D3[List Operations]
    D --> D4[Set Operations]
    D --> D5[ZSet Operations]
    D --> D6[Lock Operations]
    D --> D7[Transaction Operations]

    E --> E1[RedisTemplate]
    E --> E2[RedissonClient]
    E --> E3[åºåˆ—åŒ–ç®¡ç†]
    E --> E4[è¿æ¥æ± ç®¡ç†]

    F --> F1[Spring Data Redis]
    F --> F2[Lettuce Client]
    F --> F3[Redisson Framework]
    F --> F4[Redis Server]

    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
    style F fill:#f1f8e9
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. é—¨é¢æ¨¡å¼ (Facade Pattern)

**è®¾è®¡ç†å¿µ**ï¼šé€šè¿‡ `RedisUtils` ç±»ä½œä¸ºç»Ÿä¸€å…¥å£ï¼Œéšè—åº•å±‚å¤æ‚çš„ Redis æ“ä½œå®ç°ç»†èŠ‚ã€‚

```mermaid
classDiagram
    class RedisUtils {
        +strings() RedisStringOperations
        +hashes() RedisHashOperations
        +lists() RedisListOperations
        +sets() RedisSetOperations
        +zsets() RedisZSetOperations
        +locks() RedisLockOperations
        +tx() RedisTransactionOperations
    }

    class RedisStringOperationsImpl {
        +set(key, value, ttl)
        +get(key)
        +delete(key)
        +exists(key)
    }

    class RedisHashOperationsImpl {
        +hset(key, field, value)
        +hget(key, field)
        +hdel(key, field)
        +hgetall(key)
    }

    RedisUtils --> RedisStringOperationsImpl
    RedisUtils --> RedisHashOperationsImpl
    RedisUtils --> RedisListOperationsImpl
    RedisUtils --> RedisSetOperationsImpl
    RedisUtils --> RedisZSetOperationsImpl
    RedisUtils --> RedisLockOperationsImpl
    RedisUtils --> RedisTransactionOperationsImpl
```

### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**ç¼“å­˜æ›´æ–°ç­–ç•¥**ï¼šæ”¯æŒå¤šç§ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼Œé€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯ã€‚

```mermaid
classDiagram
    class UpdateStrategy {
        <<enumeration>>
        WRITE_THROUGH
        WRITE_BEHIND
        WRITE_AROUND
        REFRESH_AHEAD
    }

    class CacheUpdateHandler {
        <<interface>>
        +handle(key, value, strategy)
    }

    class WriteThroughHandler {
        +handle(key, value, strategy)
    }

    class WriteBehindHandler {
        +handle(key, value, strategy)
    }

    class WriteAroundHandler {
        +handle(key, value, strategy)
    }

    CacheUpdateHandler <|-- WriteThroughHandler
    CacheUpdateHandler <|-- WriteBehindHandler
    CacheUpdateHandler <|-- WriteAroundHandler
    UpdateStrategy --> CacheUpdateHandler
```

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

**æ€§èƒ½ç›‘æ§**ï¼šé€šè¿‡äº‹ä»¶é©±åŠ¨çš„æ–¹å¼æ”¶é›†ç¼“å­˜æ€§èƒ½æŒ‡æ ‡ã€‚

```mermaid
sequenceDiagram
    participant Client
    participant CacheAspect
    participant MetricsCollector
    participant MonitoringSystem

    Client->>CacheAspect: è°ƒç”¨ç¼“å­˜æ–¹æ³•
    CacheAspect->>CacheAspect: æ‰§è¡Œç¼“å­˜é€»è¾‘
    CacheAspect->>MetricsCollector: å‘é€æ€§èƒ½äº‹ä»¶
    MetricsCollector->>MetricsCollector: ç»Ÿè®¡åˆ†æ
    MetricsCollector->>MonitoringSystem: æ¨é€ç›‘æ§æ•°æ®
    CacheAspect-->>Client: è¿”å›ç»“æœ
```

## ğŸ”§ æ¨¡å—æ¶æ„è¯¦è§£

### é…ç½®ç®¡ç†æ¨¡å—

**è‡ªåŠ¨é…ç½®æœºåˆ¶**ï¼šåŸºäº Spring Boot çš„æ¡ä»¶åŒ–è‡ªåŠ¨é…ç½®ï¼Œå®ç°é›¶é…ç½®å¯åŠ¨ã€‚

```mermaid
graph LR
    A[RedisCommonsAutoConfiguration] --> B[RedisConfig]
    A --> C[RedissonConfig]
    A --> D[RedisUtils Bean]
    A --> E[CacheAspect Bean]
    A --> F[TransactionAspect Bean]

    B --> B1[RedisTemplate é…ç½®]
    B --> B2[è¿æ¥æ± é…ç½®]
    B --> B3[åºåˆ—åŒ–é…ç½®]

    C --> C1[Redisson å®¢æˆ·ç«¯]
    C --> C2[åˆ†å¸ƒå¼é”é…ç½®]
    C --> C3[é›†ç¾¤é…ç½®]

    D --> D1[æ“ä½œæ¨¡å—æ³¨å…¥]
    D --> D2[äº‹åŠ¡ç®¡ç†å™¨æ³¨å…¥]
    D --> D3[æ€§èƒ½ç›‘æ§æ³¨å…¥]

    style A fill:#ff9999
    style B fill:#99ccff
    style C fill:#99ff99
```

### ç¼“å­˜å¢å¼ºæ¨¡å—

**å¤šçº§ç¼“å­˜æ¶æ„**ï¼šæ”¯æŒ L1(æœ¬åœ°ç¼“å­˜) + L2(Redisç¼“å­˜) + L3(æ•°æ®æº) çš„å¤šçº§ç¼“å­˜ä½“ç³»ã€‚

```mermaid
flowchart TD
    Request[å®¢æˆ·ç«¯è¯·æ±‚] --> L1{L1 æœ¬åœ°ç¼“å­˜}
    L1 -->|å‘½ä¸­| Return1[è¿”å›ç»“æœ]
    L1 -->|æœªå‘½ä¸­| L2{L2 Redisç¼“å­˜}
    L2 -->|å‘½ä¸­| UpdateL1[æ›´æ–°L1ç¼“å­˜]
    UpdateL1 --> Return2[è¿”å›ç»“æœ]
    L2 -->|æœªå‘½ä¸­| L3[L3 æ•°æ®æºæŸ¥è¯¢]
    L3 --> UpdateL2[æ›´æ–°L2ç¼“å­˜]
    UpdateL2 --> UpdateL1_2[æ›´æ–°L1ç¼“å­˜]
    UpdateL1_2 --> Return3[è¿”å›ç»“æœ]

    style L1 fill:#e3f2fd
    style L2 fill:#f3e5f5
    style L3 fill:#e8f5e8
    style Return1 fill:#c8e6c9
    style Return2 fill:#c8e6c9
    style Return3 fill:#c8e6c9
```

### åˆ†å¸ƒå¼é”æ¨¡å—

**é”ç®¡ç†æ¶æ„**ï¼šåŸºäº Redisson å®ç°çš„é«˜å¯é åˆ†å¸ƒå¼é”æœºåˆ¶ã€‚

```mermaid
stateDiagram-v2
    [*] --> å°è¯•è·å–é”
    å°è¯•è·å–é” --> é”è·å–æˆåŠŸ: è·å–æˆåŠŸ
    å°è¯•è·å–é” --> é”è·å–å¤±è´¥: è·å–å¤±è´¥/è¶…æ—¶

    é”è·å–æˆåŠŸ --> æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    æ‰§è¡Œä¸šåŠ¡é€»è¾‘ --> è‡ªåŠ¨ç»­çº¦: é•¿æ—¶é—´æ‰§è¡Œ
    è‡ªåŠ¨ç»­çº¦ --> æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    æ‰§è¡Œä¸šåŠ¡é€»è¾‘ --> é‡Šæ”¾é”: æ‰§è¡Œå®Œæˆ
    æ‰§è¡Œä¸šåŠ¡é€»è¾‘ --> å¼‚å¸¸å¤„ç†: æ‰§è¡Œå¼‚å¸¸

    å¼‚å¸¸å¤„ç† --> å¼ºåˆ¶é‡Šæ”¾é”
    å¼ºåˆ¶é‡Šæ”¾é” --> [*]
    é‡Šæ”¾é” --> [*]
    é”è·å–å¤±è´¥ --> [*]
```

### äº‹åŠ¡ç®¡ç†æ¨¡å—

**å£°æ˜å¼äº‹åŠ¡**ï¼šé€šè¿‡ AOP å®ç°çš„å£°æ˜å¼ Redis äº‹åŠ¡ç®¡ç†ã€‚

```mermaid
sequenceDiagram
    participant Client
    participant TransactionAspect
    participant RedisTransactionManager
    participant RedisTemplate

    Client->>TransactionAspect: @RedisTransactional æ–¹æ³•è°ƒç”¨
    TransactionAspect->>RedisTransactionManager: å¼€å§‹äº‹åŠ¡
    RedisTransactionManager->>RedisTemplate: MULTI

    loop ä¸šåŠ¡æ“ä½œ
        TransactionAspect->>RedisTemplate: æ‰§è¡Œ Redis å‘½ä»¤
        RedisTemplate-->>TransactionAspect: å‘½ä»¤å…¥é˜Ÿ
    end

    alt æ‰§è¡ŒæˆåŠŸ
        TransactionAspect->>RedisTransactionManager: æäº¤äº‹åŠ¡
        RedisTransactionManager->>RedisTemplate: EXEC
        RedisTemplate-->>TransactionAspect: æ‰§è¡Œç»“æœ
    else æ‰§è¡Œå¤±è´¥
        TransactionAspect->>RedisTransactionManager: å›æ»šäº‹åŠ¡
        RedisTransactionManager->>RedisTemplate: DISCARD
    end

    TransactionAspect-->>Client: è¿”å›ç»“æœ
```

## âš¡ æ€§èƒ½ä¼˜åŒ–æ¶æ„

### æ‰¹é‡æ“ä½œä¼˜åŒ–

**æ™ºèƒ½æ‰¹é‡åˆå¹¶**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶åˆå¹¶æ‰¹é‡æ“ä½œï¼Œå‡å°‘ç½‘ç»œ IO å¼€é”€ã€‚

```mermaid
graph TB
    A[å¤šä¸ªå•ç‹¬æ“ä½œ] --> B{æ‰¹é‡é˜ˆå€¼æ£€æµ‹}
    B -->|è¶…è¿‡é˜ˆå€¼| C[æ‰¹é‡æ“ä½œåˆå¹¶]
    B -->|æœªè¾¾é˜ˆå€¼| D[å•ç‹¬æ“ä½œæ‰§è¡Œ]

    C --> E[Pipeline æ‰¹é‡æ‰§è¡Œ]
    E --> F[ç»“æœåˆ†å‘å¤„ç†]
    F --> G[è¿”å›å¯¹åº”ç»“æœ]

    D --> H[ç›´æ¥æ‰§è¡Œ]
    H --> I[è¿”å›ç»“æœ]

    style C fill:#ffeb3b
    style E fill:#4caf50
    style F fill:#2196f3
```

### ç¼“å­˜é¢„çƒ­æœºåˆ¶

**æ™ºèƒ½é¢„çƒ­ç­–ç•¥**ï¼šåŸºäºä¼˜å…ˆçº§çš„ç¼“å­˜é¢„çƒ­ï¼Œæå‡åº”ç”¨å¯åŠ¨åæ€§èƒ½ã€‚

```mermaid
gantt
    title ç¼“å­˜é¢„çƒ­æ‰§è¡Œæ—¶åº
    dateFormat X
    axisFormat %s

    section åº”ç”¨å¯åŠ¨
    Springå®¹å™¨åˆå§‹åŒ–    :0, 5
    Redisè¿æ¥å»ºç«‹      :3, 8

    section é¢„çƒ­æ‰§è¡Œ
    é«˜ä¼˜å…ˆçº§ç¼“å­˜é¢„çƒ­    :crit, 8, 15
    ä¸­ä¼˜å…ˆçº§ç¼“å­˜é¢„çƒ­    :15, 25
    ä½ä¼˜å…ˆçº§ç¼“å­˜é¢„çƒ­    :25, 40

    section æœåŠ¡å°±ç»ª
    å¯¹å¤–æä¾›æœåŠ¡       :40, 45
```

## ğŸ” ç›‘æ§ä¸è¯Šæ–­æ¶æ„

### æ€§èƒ½æŒ‡æ ‡æ”¶é›†

**å…¨é“¾è·¯ç›‘æ§**ï¼šä»è¯·æ±‚åˆ°å“åº”çš„å…¨é“¾è·¯æ€§èƒ½æŒ‡æ ‡æ”¶é›†ã€‚

```mermaid
flowchart LR
    A[è¯·æ±‚å…¥å£] --> B[AOPæ‹¦æˆª]
    B --> C[å¼€å§‹è®¡æ—¶]
    C --> D[æ‰§è¡Œç¼“å­˜æ“ä½œ]
    D --> E[è®°å½•ç»“æœ]
    E --> F[è®¡ç®—è€—æ—¶]
    F --> G[æ›´æ–°æŒ‡æ ‡]
    G --> H[å¼‚æ­¥ä¸ŠæŠ¥]

    subgraph ç›‘æ§æŒ‡æ ‡
        I[å‘½ä¸­ç‡ç»Ÿè®¡]
        J[å“åº”æ—¶é—´åˆ†å¸ƒ]
        K[é”™è¯¯ç‡ç»Ÿè®¡]
        L[ååé‡ç»Ÿè®¡]
    end

    G --> I
    G --> J
    G --> K
    G --> L

    style B fill:#ff7043
    style G fill:#66bb6a
    style H fill:#42a5f5
```

### å¥åº·æ£€æŸ¥æœºåˆ¶

**å¤šç»´åº¦å¥åº·æ£€æŸ¥**ï¼šRedis è¿æ¥çŠ¶æ€ã€ç¼“å­˜å‘½ä¸­ç‡ã€å“åº”æ—¶é—´ç­‰å¤šç»´åº¦å¥åº·è¯„ä¼°ã€‚

```mermaid
pie title Redis Commons å¥åº·æ£€æŸ¥ç»´åº¦
    "è¿æ¥çŠ¶æ€æ£€æŸ¥" : 30
    "ç¼“å­˜å‘½ä¸­ç‡æ£€æŸ¥" : 25
    "å“åº”æ—¶é—´æ£€æŸ¥" : 20
    "å†…å­˜ä½¿ç”¨ç‡æ£€æŸ¥" : 15
    "é”™è¯¯ç‡æ£€æŸ¥" : 10
```

## ğŸ›¡ï¸ å¯é æ€§ä¿éšœæ¶æ„

### å¼‚å¸¸å¤„ç†æœºåˆ¶

**åˆ†å±‚å¼‚å¸¸å¤„ç†**ï¼šä¸åŒå±‚çº§çš„å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚

```mermaid
graph TD
    A[ä¸šåŠ¡å¼‚å¸¸] --> B{å¼‚å¸¸ç±»å‹åˆ¤æ–­}
    B -->|è¿æ¥å¼‚å¸¸| C[è¿æ¥é‡è¯•æœºåˆ¶]
    B -->|åºåˆ—åŒ–å¼‚å¸¸| D[é™çº§å¤„ç†]
    B -->|è¶…æ—¶å¼‚å¸¸| E[ç†”æ–­æœºåˆ¶]
    B -->|ä¸šåŠ¡å¼‚å¸¸| F[å¼‚å¸¸åŒ…è£…è¿”å›]

    C --> G[è‡ªåŠ¨é‡è¿]
    G --> H{é‡è¿æˆåŠŸ?}
    H -->|æ˜¯| I[ç»§ç»­æ‰§è¡Œ]
    H -->|å¦| J[é™çº§å¤„ç†]

    D --> K[ä½¿ç”¨é»˜è®¤åºåˆ—åŒ–]
    E --> L[å¿«é€Ÿå¤±è´¥]
    F --> M[è¿”å›ä¸šåŠ¡å¼‚å¸¸]

    style C fill:#ffcdd2
    style G fill:#dcedc8
    style L fill:#ffecb3
```
